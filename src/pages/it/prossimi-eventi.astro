---
import type { Lang } from '@i18n/types';
import UpcomingEventsLayout from '@layouts/UpcomingEvents.astro';
import {fetchNextUpcomingRomajsEvent} from '@api/meetup/queries.server';
import {startOfMonth, addMonths, nextWednesday, isWednesday} from 'date-fns';

const title: string = 'Prossimi Eventi';
const lang: Lang = 'it';
const description = 'Tutti i prossimi eventi in programma del RomaJS';

const upcomingEvents = await fetchNextUpcomingRomajsEvent();

const lastUpcomingEventDate = upcomingEvents?.at(-1)?.dateTime || Date.now();

const nextThreeMeetups = [1, 2, 3].map(month => {
  const firstDayOfNextMonth = startOfMonth(addMonths(new Date(lastUpcomingEventDate), month));

  if(isWednesday(firstDayOfNextMonth)) {
    return nextWednesday(nextWednesday(firstDayOfNextMonth));
  }

  return nextWednesday(nextWednesday(nextWednesday(firstDayOfNextMonth)));
});
---

<UpcomingEventsLayout
  title={title}
  lang={lang}
  description={description}
  upcomingEvents={upcomingEvents}
  nextEvents={nextThreeMeetups}
/>
